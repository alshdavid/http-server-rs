name: Release

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

on: 
  push:
    branches:
      - "main"

env:
  JUST_VERSION: "1.38.0"

jobs:
  tests:
    name: ğŸ§ª Tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - run: source ./.github/setup/just/install.bash
      - run: source ./.github/setup/rust/install.bash
      - run: just test
        
  format:
    name: ğŸ“ Format
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - run: source ./.github/setup/just/install.bash
      - run: source ./.github/setup/rust/install.bash
      - run: just fmt
        
  lint:
    name: ğŸ¤“ Lint
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - run: source ./.github/setup/just/install.bash
      - run: source ./.github/setup/rust/install.bash
      - run: just lint

  build_linux_amd64:
    name: ğŸ¥ Linux AMD64
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - run: source ./.github/setup/just/install.bash
      - run: source ./.github/setup/rust/install.bash
      - env: { os: "linux", arch: "amd64", profile: "release" }
        run: just build
      - uses: actions/upload-artifact@v4
        with:
          name: http-server-linux-amd64
          path: ${{ github.workspace }}/target/linux-amd64/**/*
          if-no-files-found: error
          retention-days: 1

  build_linux_arm64:
    name: ğŸ¥ Linux ARM64
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - run: source ./.github/setup/just/install.bash
      - run: source ./.github/setup/rust/install.bash
      - env: { os: "linux", arch: "arm64", profile: "release" }
        run: just build
      - uses: actions/upload-artifact@v4
        with:
          name: http-server-linux-arm64
          path: ${{ github.workspace }}/target/linux-arm64/**/*
          if-no-files-found: error
          retention-days: 1

  # build_macos_amd64:
  #   name: ğŸ MacOS AMD64
  #   runs-on: macos-13
  #   steps:
  #     - uses: actions/checkout@v4
  #     - run: source ./.github/setup/just/install.bash
  #     - run: source ./.github/setup/rust/install.bash
  #     - env: { os: "macos", arch: "amd64", profile: "release" }
  #       run: just build
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: http-server-macos-amd64
  #         path: ${{ github.workspace }}/target/macos-amd64/**/*
  #         if-no-files-found: error
  #         retention-days: 1

  # build_macos_arm64:
  #   name: ğŸ MacOS ARM64
  #   runs-on: macos-15
  #   steps:
  #     - uses: actions/checkout@v4
  #     - run: source ./.github/setup/just/install.bash
  #     - run: source ./.github/setup/rust/install.bash
  #     - env: { os: "macos", arch: "arm64", profile: "release" }
  #       run: just build
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: http-server-macos-arm64
  #         path: ${{ github.workspace }}/target/macos-arm64/**/*
  #         if-no-files-found: error
  #         retention-days: 1

  # build_windows_amd64:
  #   name: ğŸŸ¦ Windows AMD64
  #   runs-on: windows-2025
  #   steps:
  #     - uses: actions/checkout@v4
  #     - run: . ./.github/setup/just/install.ps1
  #     - run: . ./.github/setup/rust/install.ps1
  #     - env: { os: "windows", arch: "amd64", profile: "release" }
  #       run: just build
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: http-server-windows-amd64
  #         path: ${{ github.workspace }}/target/windows-amd64/**/*
  #         if-no-files-found: error
  #         retention-days: 1

  # build_windows_arm64:
  #   name: ğŸŸ¦ Windows ARM64
  #   runs-on: windows-2025
  #   steps:
  #     - uses: actions/checkout@v4
  #     - run: . ./.github/setup/just/install.ps1
  #     - run: |
  #         . ./.github/setup/rust/install.ps1
  #         rustup target add aarch64-pc-windows-msvc
  #     - env: { os: "windows", arch: "arm64", profile: "release" }
  #       run: just build
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: http-server-windows-arm64
  #         path: ${{ github.workspace }}/target/windows-arm64/**/*
  #         if-no-files-found: error
  #         retention-days: 1

  publish-github-release:
    name: "ğŸ”„ Publish Github Release"
    runs-on: ubuntu-latest
    needs: 
      # - test
      # - format
      # - lint
      - build_linux_amd64
      - build_linux_arm64
      # - build_macos_amd64
      # - build_macos_arm64
      # - build_windows_amd64
      # - build_windows_arm64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with: { path: artifacts }
      - name: Publish` Github Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          TAG="$(date -u +"v%Y.%m.%d.%H%M").${GITHUB_SHA::4}"
          echo "Tag: ${TAG}"
          
          gh release create $TAG  --draft --notes "Automatically built binaries"
          gh release edit $TAG --title "ğŸš€ Latest"

          cd artifacts

          for name in *; do
            cd "${{ github.workspace }}/artifacts/${name}/release"
            tar -czvf ./${name}.tar.gz ./*
            gh release upload $TAG ${name}.tar.gz
          done
         
          gh release edit $TAG --draft=false
